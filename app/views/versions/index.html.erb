<%= render "dropbox/breadcrumbs" %>

<script>

var dropbox_to_version = {};

function addMap(dropbox_id, version){
  console.log("DO THINGS");
  dropbox_to_version[dropbox_id] = version;
}


$(document).ready(function(){

  //     var viewer = new modelViewer("#container", "#annotation_list",<%= @model.id %>, <%= @member.id %>);
  // this.id = 

  //UI METHODS

  //HOVER OVER for marked -> unmark
  $('.versions').on('hover', 'div.action.marked', function(event){
    event.preventDefault();
    if (event.type == "mouseenter"){
      $(this).addClass('unmark');
    } else {
       $(this).removeClass('unmark');
    }
    
  });

  //Add input on unmarked click
  $('.versions').on('click', 'div.action.unmarked', function(){
    var parent = $($(this).parent());
    var input_element = "<input type='text' placeholder='Enter commit message here'>";
    parent.find('.message').html(input_element);
    parent.find('.message').find('input').focus();
  });

  //Input enter just blurs it
  $('.versions .message').on('keyup', 'input', function(event){
    if (event.keyCode == 13) {
        $(this).blur();
    }
  });

  //Blur calls success
  $('.versions .message').on('blur', 'input', function(event){
    //TODO: BLUR IS BEING CALLED TWICE SO THATS TWO POSTS!!
    commiteRevision(this); 
  });


  //MODEL FOR REVISIONS
  Revision = function(modelID, json) 
  {

    var modelID = modelID;
    var revision_id = ;
    var date = ;
    var version = null;
    var message = "Test";

    var genFromJson(j){
      revision_id = parseInt(j.revision_number);
      message = j.details;
      date =  j.revision_date;
      //TODO: version =?
    }

    var returnUI() {
      //TODO could do caching
      var rev_html = "";
      rev_html += "<div class='dropbox'>" + revision_id + '</div>';
      rev_html += "<div class='date'>" + date + '</div>';
      if (version === null) {
        rev_html += "<div class='action unmarked'></div>"
      } else {
         rev_html += "<div class='action marked'></div>"
         rev_html += "<div class='message'> <a href=\"/versions/" + version + '\">' + message + "</div>";
      }
    }

    this.revision_id = function() {
      return revision_id;
    }

    this.commit = function() {
      $.post('/model_files/' + modelID + '/versions', {"revision_number": revision_id, "details": message, "revision_date": date}, function(data){
        version = data.trim();
      }
    }

    this.rollback = function(){
      $.ajax({
      url: '/versions/' + version,
      type: 'DELETE',
      success: function(result) {
          version = null;
        }
      });
    }

  }

  //USE MODEL TO GENERATE UI
  var revisionList = {};

  function updateRevisionUI() {
    $('.versions').html("");
    for (var key in revisionList){
      $('.versions').append("<li>" + revisionsList[key].returnUI() + "</li>");
    }
  }

  function initializeRevisions()) {
    //GET DATA for revisions then for each revision r 
    //var r = new Revision(id);
    //revisionList[r.revision_id()] = r;
    updateRevisionUI();
  }


  function commitRevision(element) {
      var dropbox_id = message_element.parent().find('.dropbox').html().trim();
      revisionList[dropbox_id].commit();
      updateRevisionUI();
  }

  //Unmark click deletes it
  $('.versions').on('click', 'div.action.marked.unmark', function(){
    var dropbox_id = $(this).parent().find('.dropbox').html().trim();
    revisionList[dropbox_id].rollback();
    updateRevisionUI();
  });
  

});
</script>

<h1> <%= @model.id %> </h1>
<div class="row versions">

  <ul>
    <li class="subtitle"> 
      <div class="dropbox"> Version number</div>
      <div class="date"> Last changed</div>
      <div class="action"> </div>
      <div class="message"> Commit message </div>
    </li>

    <!-- THIS NEEDS TO BE REPLACED. SHOULD DO A GET AND THen perform operations -->
    <% @dropbox_revisions.each do |revision| %>
    <li>
      <div class="dropbox"> <%= revision[:rev] %> </div>
      <div class="date"> <%= revision[:modified].to_datetime.strftime("%B %d, %Y") %> </div>
      <div class=" <%= revision[:version] ? "action marked" : "action unmarked" %>" > </div>
      <div class="message"> <%= link_to revision[:details], revision[:version] %> </div>
    </li>
    <% end %>

  </ul>
</div>
