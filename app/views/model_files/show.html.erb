<%= render "dropbox/breadcrumbs" %>

<%= render "model_files/model_viewer" %>
<script>
$(document).ready(function(){

  $('.versions').on('hover', 'div.action.marked', function(event){
    event.preventDefault();
    if (event.type == "mouseenter"){
      $(this).addClass('unmark');
      $(this).html('unmark');
    } else {
       $(this).removeClass('unmark');
      $(this).html('Marked as version');
    }
    
  });

  $('.versions').on('click', 'div.action.unmarked', function(){
    var parent = $($(this).parent());
    var input_element = "<input type='text' placeholder='Enter commit message here'>";
    parent.find('.message').html(input_element);
    parent.find('.message').find('input').focus();
  });

  $('.versions').on('click', 'div.action.marked.unmark', function(){
    console.log("deleting");
  });

  $('.versions .message').on('keyup', 'input', function(event){
    if (event.keyCode == 13) {
        $(this).blur();
    }
  });

  $('.versions .message').on('blur', 'input', function(event){
    //TODO: BLUR IS BEING CALLED TWICE SO THATS TWO POSTS!!
    submitMessage(this);
  });

  function submitMessage(element){

    //Update the message to be accurate
    var message_element = $(element).parent();
    var message = $(element).val();
    message_element.html(message);

    //Get the dropbox id
    var dropbox_id = message_element.parent().find('.dropbox').html();
    console.log(dropbox_id);

    //Post both of them

    var action_element = message_element.parent().find('.action');
    console.log(action_element);
    action_element.removeClass('unmarked');
    action_element.addClass('marked');
    action_element.html('Marked as version');
  }




  $(':checkbox').change(function(){ 
  
  var children = $(this).parent().parent().children();

  var versionNumber =  $(children[0]).html().trim();
  var revisionNumber = $(children[1]).html().trim();

  console.log(versionNumber);
  console.log(revisionNumber);

  if($(this).is(':checked')) {
    
    $.post('/model_files/' + <%= @model.id %> + '/revisions', {"revision_number": versionNumber}, function(data){
      console.log($(this).parent().find(".fabbit"));
      $(children[1]).html(data);
    });

  } else {
    
    $.ajax({
      url: '/revisions/' + revisionNumber  ,
      type: 'DELETE',
      data: revisionNumber,
      success: function(result) {
          $(children[1]).html('x');
      }
    });
  }

  });

});
</script>
<div class="row versions">
  <ul>
    <li class="subtitle"> 
      <div class="dropbox"> Version number</div>
      <div class="date"> Last changed</div>
      <div class="action"> </div>
      <div class="message"> Commit message </div>
    </li>
    <li>
      <div class="dropbox"> 2as931s9a </div>
      <div class="date"> Tue, 23 April 2013 </div> 
      <div class="action unmarked"> Mark as version </div>
      <div class="message"> </div>
    </li>
    <li>
      <div class="dropbox"> 2as931s9a </div>
      <div class="date"> Tue, 23 April 2013 </div> 
      <div class="action marked"> Marked as version </div>
      <div class="message"> </div>
    </li>

  </ul>
</div>


